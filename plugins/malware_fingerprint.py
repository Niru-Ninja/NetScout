import re
import requests

NAME = "malware_fingerprint"
DESCRIPTION = "Heurísticas para detectar paneles C2, webshells o compromisos"
RUNS_ON_PORTS = [80, 443]

# --- Firmas conocidas --------------------------------------------------------

# Webshells C99 / R57 / WSO
WEBSHELL_PATTERNS = [
    r"WSO\s*Shell",
    r"C99\s*shell",
    r"R57\s*Shell",
    r"cmd=echo\s*\$",
    r"File\s*manager\s*WSO",
    r"shell_exec\(",
]

# Paneles C2 comunes
C2_PATTERNS = [
    r"botnet",
    r"command\s*and\s*control",
    r"cnc\s*server",
    r"malware\s*panel",
    r"unauthorized\s*access\s*panel",
]

# Indicadores generales de compromiso
HEURISTIC_PATTERNS = [
    r"base64_decode\(.{200,}\)",        # Payload oculto
    r"eval\(.{100,}\)",                 # Eval con contenido largo
    r"<script>.*?atob\(.*?</script>",   # JS que decodifica payloads
    r"\/admin\/panel\/login\.php",      # Paneles ocultos
    r"\/api\/gate\/connect",            # Común en botnets
    r"\/gate\.php",                     # Muy común en stealers
]

# -----------------------------------------------------------------------------


def run(ip, ports, scan_id, save):
    for port in ports:
        url = f"http://{ip}:{port}"
        try:
            resp = requests.get(url, timeout=5, verify=False)
        except Exception:
            continue

        html = resp.text
        findings = []
        score = 0

        # --- 1. Webshell detections (HIGH) ---
        for pat in WEBSHELL_PATTERNS:
            if re.search(pat, html, re.IGNORECASE):
                findings.append(f"webshell_signature: {pat}")
                score += 7

        # --- 2. C2 panel detections (HIGH/MEDIUM) ---
        for pat in C2_PATTERNS:
            if re.search(pat, html, re.IGNORECASE):
                findings.append(f"c2_panel: {pat}")
                score += 5

        # --- 3. Heuristic detections (LOW/MEDIUM) ---
        for pat in HEURISTIC_PATTERNS:
            if re.search(pat, html, re.IGNORECASE | re.DOTALL):
                findings.append(f"heuristic_match: {pat}")
                score += 2

        # --- BONUS: Ofuscación fuerte en JS ---
        long_hex = re.findall(r"[0-9a-fA-F]{200,}", html)
        if long_hex:
            findings.append("js_obfuscation_detected")
            score += 3

        # --- Si no se encontró nada ---
        if not findings:
            print(f"{NAME}: Nothing on {ip}...")
            continue

        # --- Guardar resultados ---
        save(NAME, f"score:{score}", ip)
        print(f"{NAME} {ip} SCORE {score}")
        for f in findings:
            save(NAME, f, ip)
